# تقرير مراجعة الأداء (Performance Audit) — مشروع نور

## 1. التقنيات المستخدمة في المشروع

### إدارة الحالة (State Management)
| التقنية | الاستخدام | الملفات |
|---------|-----------|---------|
| **Provider** | Locale، Auth (قراءة/كتابة) | `main.dart`, `main_screen.dart`, `athari_tab.dart`, `auth_choice_screen.dart` |
| **flutter_hooks** | useState, useEffect, useMemoized, useStream, useTabController | معظم الشاشات والتابات |
| **ValueNotifier** (داخل hooks) | تحديثات محلية (مثل العد التنازلي، الصفحة الحالية) | `mihrab_tab.dart`, `mushaf_view.dart` |
| **Isar .watch()** | تيار تفاعلي للمهام اليومية | `athari_tab.dart` |

**ملاحظة:** لا يوجد GetX في كود التطبيق نفسه، لكن **quran_library** تعتمد على **Get** (GetX) داخلياً؛ قد يؤثر على حجم الـ bundle والتهيئة.

---

### جلب البيانات ومعالجتها
| المصدر | الطريقة | ملاحظات |
|--------|---------|---------|
| **Isar** | قراءة/كتابة محلية، واستعلامات + `watch` | `isar_service.dart`, `athari_tab`, `majlis_tab`, `seed_service` |
| **Supabase** | تهيئة العميل فقط في `main` | لا جلب بيانات ظاهر في المسح الحالي |
| **quran_library** | بيانات مصحف محلية (JSON/أصول داخل الحزمة) | تحميل عند `QuranLibrary.init()`، ثم `getAyahsByPage`, `getSurahInfo`, `surahsStart` |

لا توجد استدعاءات API خارجية لجلب نصوص القرآن؛ كل البيانات من الحزمة.

---

### معالجة الصور والأصول
| النوع | الاستخدام |
|-------|-----------|
| **Image.asset** | شعار التطبيق في `auth_choice_screen` و `splash_landing_screen` (`newesteanalogo.png`) |
| **أصول quran_library** | خطوط (Uthmanic Hafs، Naskh، إلخ) و SVG و JSON داخل الحزمة |

لا توجد ضغوط صور (resize/compress) في الكود الحالي. حجم أصول التطبيق نفسه محدود (شعار واحد).

---

### عمليات قد تكون ثقيلة على الـ Main Thread

1. **فهرس المصحف (MushafIndexView)**  
   - **المشكلة:** استدعاء `MushafService.getAllSurahsForIndex()` داخل `build()`.  
   - **التأثير:** في كل إعادة بناء للشاشة يتم إنتاج قائمة 114 سورة مع 114 استدعاء لـ `getSurahInfo()` وقراءة `surahsStart`.  
   - **النتيجة:** عمل غير ضروري على الـ Main Thread وزيادة زمن الإطار (Frame time) عند فتح التاب أو إعادة البناء.

2. **اسم السورة في شريط المصحف (MushafView)**  
   - **المشكلة:** استدعاء `MushafService.getSurahNameForPage(currentPage.value)` في كل `build` (حتى عند عدم تغيّر الصفحة)، وداخلها: `getAyahsByPage()` ثم `getSurahInfo()`.  
   - **التأثير:** تكرار نفس الحساب في كل إعادة بناء (بما فيها تلك الناتجة عن تحديثات أخرى في الشجرة).  
   - **النتيجة:** احتمال ظهور هنج أو تأخر بسيط أثناء التمرير أو عند تفاعلات أخرى.

3. **عد تنازلي المحراب (MihrabTab)**  
   - **المشكلة:** `Timer.periodic(Duration(seconds: 1))` يحدّث `now.value` كل ثانية.  
   - **التأثير:** إعادة بناء كامل لـ `MihrabTab` (بما فيه البطاقات والوصول السريع) مرة كل ثانية.  
   - **النتيجة:** rebuilds غير ضرورية لشجرة كبيرة رغم أن المتغيّر هو العد التنازلي فقط.

4. **غياب RepaintBoundary**  
   - **المشكلة:** لا يوجد استخدام لـ `RepaintBoundary` في الكود الحالي.  
   - **التأثير:** أي منطقة تحتاج إعادة رسم (مثل صفحة المصحف أو شريط اسم السورة) قد تؤدي إلى إعادة رسم أوسع.  
   - **النتيجة:** استهلاك إضافي للـ GPU وزيادة احتمال الـ jank أثناء التمرير أو تغيير الصفحة.

5. **خطوط Google Fonts في الثيم**  
   - **الوضع الحالي:** استدعاء `GoogleFonts.tajawalTextTheme()` و `GoogleFonts.plusJakartaSansTextTheme()` داخل دوال بناء الثيم (عند تغيير اللغة/الثيم).  
   - **التأثير:** مقبول إذا كان يحدث عند تغيير الثيم/اللغة فقط وليس في كل إطار. إن تم استدعاؤها في مسار يُنفَّذ كل إطار فستكون مشكلة.

---

## 2. أسباب محتملة للبطء والـ Lag

| السبب | الوصف |
|-------|--------|
| **حساب الفهرس في كل build** | `getAllSurahsForIndex()` يُنفَّذ عند كل rebuild لـ `MushafIndexView` دون تخزين مؤقت. |
| **حساب اسم السورة في كل build** | `getSurahNameForPage()` يُستدعى أكثر من مرة في نفس الإطار (حالة أولية، شريط علوي، وأحياناً fallback). |
| **Rebuilds كل ثانية في المحراب** | تحديث العد التنازلي يحرّك rebuild للتاب بالكامل. |
| **عدم عزل الرسم** | عدم استخدام `RepaintBoundary` حول منطقة المصحف وشريط الاسم يزيد من حجم الشجرة المرسومة عند كل تغيير. |
| **ثقل الحزمة quran_library** | الاعتماد على Get، dio، just_audio، وعدد كبير من الخطوط والأصول قد يزيد زمن البدء والحجم؛ التمرير يعتمد على كيفية بناء الحزمة لصفحات المصحف (قد تكون نصوص/خطوط معقدة لكل صفحة). |

---

## 3. تحسينات فورية مقترحة (ومطبقة في الكود)

### 3.1 تخزين مؤقت لفهرس السور (MushafService)
- **الإجراء:** تخزين نتيجة `getAllSurahsForIndex()` في متغير ثابت (static cache) بعد أول حساب.  
- **الفائدة:** عدم إعادة حساب 114 سورة في كل rebuild للفهرس.

### 3.2 تخزين مؤقت لاسم السورة حسب الصفحة (MushafService)
- **الإجراء:** خريطة ثابتة `pageNumber -> surahName` تُملأ عند أول طلب لكل صفحة (أو مسبقاً للصفحات 1..604 إذا رغبت).  
- **الفائدة:** تقليل استدعاءات `getAyahsByPage` و `getSurahInfo` أثناء التمرير وعند rebuild.

### 3.3 عدم حساب الفهرس داخل build (MushafIndexView)
- **الإجراء:** استخدام `useMemoized` (أو ما يعادله) لاستدعاء `getAllSurahsForIndex()` مرة واحدة عند أول بناء، واعتماد القائمة المخزنة من الخدمة إن وُجدت.  
- **الفائدة:** إزالة العمل الثقيل من مسار الـ build.

### 3.4 RepaintBoundary حول المناطق المعقدة
- **الإجراء:**  
  - لف شريط اسم السورة + رقم الصفحة في `RepaintBoundary`.  
  - لف محتوى صفحة المصحف (الـ `QuranPagesScreen` أو المنطقة التي تعيد رسمها الحزمة) في `RepaintBoundary`.  
  - لكل عنصر في فهرس السور (مثلاً كل `Card` أو كل صف) استخدام `RepaintBoundary` لاحتواء إعادة الرسم عند التمرير.  
- **الفائدة:** عزل إعادة الرسم وتقليل الـ jank.

### 3.5 تقليل نطاق rebuild العد التنازلي (MihrabTab)
- **الإجراء:** استخراج العد التنازلي إلى widget فرعي يملك `useState` + `Timer.periodic` خاصاً به، بحيث فقط هذا الـ widget يُعاد بناؤه كل ثانية وليس التاب بالكامل.  
- **الفائدة:** تقليل حجم الشجرة المُعاد بناؤها كل ثانية.

### 3.6 خطوط المصحف داخل quran_library
- الخطوط (مثل Uthmanic Hafs) تُحمّل كأصول الحزمة؛ التأكد من أن الحزمة لا تعيد تحميل الخطوط في كل frame (عادة تُحمّل مرة). إن وُجدت في الوثائق أو الكود إعدادات لـ font caching أو precache يمكن تفعيلها.

---

## 4. ملخص التقنيات (مرجع سريع)

| الفئة | التقنيات |
|-------|----------|
| **State Management** | Provider (Locale, Auth), flutter_hooks (useState, useEffect, useMemoized, useStream, useTabController) |
| **قاعدة البيانات المحلية** | Isar (مع watch للتفاعل) |
| **جلب البيانات** | Isar فقط في الكود الحالي؛ quran_library للقرآن (بيانات محلية) |
| **الصور** | Image.asset لشعار التطبيق؛ لا معالجة ثقيلة |
| **الخطوط** | Google Fonts في ثيم التطبيق؛ خطوط المصحف من quran_library |
| **شبكة** | Supabase (تهيئة)، quran_library قد تستخدم dio داخلياً |

---

## 5. خطوات مقترحة لاحقة (بعد التحسينات الفورية)

- قياس زمن الإطار (Frame timing) في DevTools أثناء التمرير في المصحف وفي الفهرس.  
- مراجعة إعدادات quran_library (مثل cache للصفحات أو الخطوط) إن وُجدت.  
- استكشاف تفعيل **addRepaintBoundaries** و **addAutomaticKeepAlives** لـ ListView/PageView إن كانت مناسبة دون تأثير سلبي على الذاكرة.  
- مراقبة استهلاك الذاكرة عند فتح المصحف والتنقل بين التابات لفترات طويلة (لا تسريب للمشتركين أو الـ controllers).

تم تطبيق التحسينات الفورية (3.1–3.5) في الكود؛ يمكن الرجوع إلى التعديلات في `mushaf_service.dart`, `mushaf_view.dart`, `mushaf_index_view.dart`, و `mihrab_tab.dart`.

---

## 6. كيف تتتبع البطء وتُرسل المعلومات لتحليلها

حتى نحدد مكان المشكلة بدقة، اتبع الآتي ثم أرسل النتائج (نص + لقطات شاشة إن أمكن).

### 6.1 تشغيل التطبيق بوضع Profile (مهم)

```bash
flutter run --profile
```

**لا تستخدم `--debug`** عند قياس الأداء؛ الوضع الـ debug أبطأ ويشوه النتائج. استخدم **`--profile`** أو على جهاز حقيقي **`--release`** لقياس أقرب للواقع.

---

### 6.2 فتح DevTools وتبويب Performance

1. بعد تشغيل التطبيق اضغط في الطرفية على الرابط الذي يظهر (مثل `http://127.0.0.1:9100?uri=...`) أو نفّذ:
   ```bash
   flutter pub global run devtools
   ```
2. من DevTools اختر **Performance** (أو **أداء**).
3. اضغط **Record** (أو ابدأ التسجيل)، ثم **في التطبيق** نفّذ الحركة التي تسبب البطء (مثلاً: تمرير المصحف، أو فتح الفهرس والتمرير، أو التبديل بين التابات).
4. بعد 5–10 ثوانٍ أوقف التسجيل.

---

### 6.3 ماذا تلاحظ وتُسجّل (لترسله لاحقاً)

| ما تلاحظه | أين تراه | ما تكتبه أو تلتقطه |
|-----------|----------|---------------------|
| **ارتفاع شريط الإطار (أحمر/أصفر)** | في التطبيق: شريط علوي/s overlay إن فعّلته (انظر 6.5) | "عند التمرير في المصحف الشريط يصير أحمر" + لقطة شاشة |
| **Frame time أعلى من ~16 ms** | DevTools > Performance > Timeline (عمود Flutter) | "أثناء التمرير Frame يصل 80ms" + لقطة للـ timeline |
| **Build/Layout يأخذ وقتاً طويلاً** | نفس الـ Timeline: ابحث عن `build` أو `layout` أو `paint` | "قسم build يأخذ 50ms" + لقطة للشريط الزمني |
| **شاشة أو حركة محددة** | — | "البطء يظهر فقط عند فتح تاب المصحف" أو "عند أول تمرير في الفهرس" |

---

### 6.4 ما ترسله عند طلب المساعدة

انسخ والصق النص التالي واملأه ثم أرسله (مع لقطات الشاشة إن وجدت):

```
**الجهاز:** [مثال: Android 14 / iPhone 15 / محاكي]
**وضع التشغيل:** profile أم release
**أين يظهر البطء؟**
  - [ ] تمرير صفحات المصحف
  - [ ] تمرير فهرس السور
  - [ ] التبديل بين تاب مصحف وتاب فهرس
  - [ ] شاشة المحراب (عد تنازلي)
  - [ ] أخرى: ___________
**متى بالضبط؟** (مثال: "فور فتح المصحف" أو "بعد التمرير 10 ثوانٍ")
**Frame time تقريباً إن ظهر:** (من DevTools أو من الشريط) _____ ms
**مرفق:** [لقطات شاشة من DevTools Timeline أو من Performance overlay]
```

---

### 6.5 عرض شريط الأداء داخل التطبيق (اختياري)

لتشوف مباشرة إن الإطار تأخر (شريط أحمر/أصفر) **بدون** فتح DevTools:

1. في `main.dart` أو في الشاشة التي تختبرها، استخدم `MaterialApp` مع:
   ```dart
   showPerformanceOverlay: true,  // مؤقتاً للتشخيص فقط
   ```
2. شغّل التطبيق بـ `--profile`.
3. نفّذ الحركة التي تسبب البطء؛ إذا ظهر شريط أحمر أو أصفر فوق الواجهة فالإطار تجاوز 16ms.
4. **احذف أو ضع `showPerformanceOverlay: false`** قبل النشر.

---

### 6.6 تسجيل أحداث مخصصة (إن طُلب منك لاحقاً)

إذا طُلب منك "تسجيل حدث عند التمرير" يمكن إضافة في الكود:

```dart
import 'dart:developer' as developer;

// داخل الـ callback الذي يعمل عند التمرير أو تغيير الصفحة:
developer.Timeline.startSync('mushaf_page_change');
// ... الكود الحالي ...
developer.Timeline.finishSync();
```

ثم في DevTools > Performance ابحث عن `mushaf_page_change` لمعرفة كم استغرق هذا الجزء. لا تضف هذا إلا إذا طُلب منك لتشخيص أعمق.
