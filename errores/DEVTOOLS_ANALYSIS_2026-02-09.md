# تحليل أداء التطبيق — تصدير DevTools 2026-02-09

## مصدر البيانات
- الملف: `dart_devtools_2026-02-09_17_09_20.012.json`
- معدل تحديث الشاشة: **90 Hz**
- ميزانية الإطار: **11.11 ms**

---

## إحصائيات الإطارات (1052 إطار)

| المؤشر | القيمة |
|--------|--------|
| **نسبة الإطارات البطيئة (Jank)** | **23.5%** (247 إطار) |
| إطارات فيها Build فوق الميزانية | 110 |
| إطارات فيها Raster فوق الميزانية | 2 فقط |

### توزيع الأوقات (بالمللي ثانية)

| المرحلة | P50 | P90 | P99 |
|---------|-----|-----|-----|
| **elapsed** (إجمالي الإطار) | 6.94 | 17.96 | 30.32 |
| **build** (خيط الـ UI) | 2.1 | 11.41 | 20.45 |
| **raster** (الرسم) | 3.1 | 5.0 | 7.72 |

الخلاصة: معظم التأخير من مرحلة **Build** (الـ Layout والـ build في خيط الـ UI)، ومرحلة Raster مقبولة.

---

## أسوأ 5 إطارات (حسب elapsed)

| رقم الإطار | elapsed (ms) | build (ms) | raster (ms) |
|------------|--------------|-----------|-------------|
| 2899 | 61.84 | 2.24 | 1.33 |
| 3170 | 41.97 | 3.91 | 2.96 |
| 2947 | 40.12 | 4.21 | 2.69 |
| 2667 | 36.76 | 4.44 | 2.63 |
| 3171 | 35.57 | 3.7 | 4.61 |

في الإطارات الأسوأ، الـ elapsed كبير بينما build/raster صغيران نسبياً — قد يكون السبب انتظار vsync أو عمل خارج الـ trace (مثلاً GC أو كود أصلي).

---

## نقاط إعادة البناء (Rebuild) الأكثر نشاطاً

من `rebuildCountModel.locations` وعدد مرات إعادة البناء في العينة:

| الملف | ملاحظة |
|-------|--------|
| **lib/widgets/app_card.dart** | عدد كبير من الـ ids مع إعادة بناء متكررة (13–16 مرة في إطار واحد) — يُستخدم في القوائم (المصحف، أثري، المجلس). |
| **lib/screens/mushaf/mushaf_index_screen.dart** | ListView.builder وعناصر البطاقات (خطوط ~49–50) تُعاد بناؤها كثيراً. |
| **lib/screens/tabs/athari_tab.dart** | مكوّنات ذات إعادة بناء 25 مرة في إطار واحد. |
| **lib/screens/tabs/mihrab_tab.dart** | عدة ويدجتات تُعاد بناؤها. |
| **lib/widgets/luminous_floating_box.dart** | يشارك في إعادة البناء. |

---

## التوصيات

1. **تقليل إعادة بناء AppCard**
   - تحويل أجزاء ثابتة من البطاقة إلى ويدجتات منفصلة مع `const` حيث ممكن.
   - التأكد من أن الـ parent لا يمرّر كائنات جديدة (مثل `Color` أو `EdgeInsets` مُنشأة في الـ build) لكل إطار.

2. **قوائم المصحف والأثري**
   - التأكد من استخدام `ListView.builder` وعدم استدعاء دوال ثقيلة داخل `itemBuilder` (مثل إنشاء قوائم أو استعلامات).
   - إعطاء عناصر القائمة مفتاحاً ثابتاً (مثلاً `ValueKey(index)` أو أفضل حسب المحتوى) إن كان ذلك يقلل إعادة البناء غير الضرورية.

3. **تاب أثري**
   - مراجعة الـ streams و`useStream` — إن كان التحديث يصل كل إطار أو بتردد عالٍ، تقليل التحديثات أو عزل الجزء الذي يعيد البناء في ويدجت أصغر.

4. **الصندوق الطافي (LuminousFloatingBox)**
   - موجود داخل `RepaintBoundary` — إن كان يزال يظهر كثيراً في إحصائيات إعادة البناء، يمكن عزله أكثر (مثلاً تحريكه إلى ويدجت أعلى أو تقليل الاعتماد على الـ context).

5. **تفعيل Trace Layouts**
   - في DevTools → Enhance Tracing → تفعيل **Trace layouts** ثم إعادة تسجيل التمرير لمعرفة أي ويدجت بالاسم يستهلك وقت الـ Layout في الإطارات الحمراء.

---

تم استخراج هذه النتائج من نفس ملف الـ JSON دون فك تشفير الـ `traceBinary` بالكامل؛ للتحليل التفصيلي للأحداث استخدم واجهة Performance في DevTools مع **Trace layouts** و **Rebuild stats**.

---

## مقارنة مع تصدير لاحق (17:26:53)

| المؤشر | تصدير 17:09 | تصدير 17:26 |
|--------|-------------|-------------|
| إجمالي الإطارات | 1052 | 5419 |
| **نسبة Jank** | **23.5%** | **17.0%** |
| Build فوق الميزانية | 110 | 302 (عدد أكبر لأن الإطارات أكثر) |
| Raster فوق الميزانية | 2 | 8 |
| **build P90 (ms)** | **11.41** | **9.03** |
| elapsed P90 (ms) | 17.96 | 13.96 |

تحسّن ملحوظ في نسبة الـ Jank وفي P90 لـ build و elapsed بعد تطبيق التوصيات (AppCard ثابت، keys للقوائم، Selector للبانر).

ملاحظة: تظهر إطارات فردية ثقيلة جداً (مثلاً frame 4 ≈ 784 ms، frame 2893 ≈ 533 ms) — غالباً عند بدء التشغيل أو عند تغيير شاشة كاملة؛ مراقبتها مفيدة لكنها لا تعكس التمرير اليومي.
